{% extends 'base.html' %}

{% block title %}Manage Data{% endblock %}

{% block head_styles %}
    <style>
        /* Styles specific to the management page */
        .form-section { padding: 1rem; border: 1px solid #eef; border-radius: 5px; background: #fdfdff; }
        .form-grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 0.5rem 1rem 1rem 1rem; }
        .form-grid-container.single-col { grid-template-columns: 1fr; }
        .radio-group { margin-bottom: 0.75rem; }
        .radio-group label { display: inline-block; margin-right: 1rem; font-weight: normal; }
        .radio-group input[type="radio"] { margin-right: 0.25rem; }
        .engine-list, .exception-list { list-style: none; padding: 0; }
        .engine-list li, .exception-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eef; }
        .delete-engine-btn, .delete-exception-btn { background-color: #e53e3e; font-size: 0.8rem; padding: 4px 8px; }
        .engine-form { display: flex; gap: 10px; margin-top: 1rem; }
        .engine-form input { flex-grow: 1; margin-bottom: 0; }
        .exception-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .exception-table th, .exception-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eef; }

        /* Styles for the import results box */
        .import-results { background-color: #e6f7ff; border: 1px solid #91d5ff; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; position: relative; }
        .import-results h2 { margin-top: 0; color: #0050b3; }
        .import-results .summary-grid { display: flex; gap: 2rem; margin-top: 1rem; align-items: center; }
        .import-results .stat { text-align: center; }
        .import-results .stat .label { font-size: 0.9rem; color: #595959; }
        .import-results .stat .value { font-size: 1.8rem; font-weight: bold; }
        .import-results .stat .value-success { color: #2f855a; }
        .import-results .stat .value-neutral { color: #718096; }
        .import-results .stat .value-error { color: #c53030; }
        .import-results .actions { margin-top: 1.5rem; }
        .import-results .dismiss-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #8c8c8c; }
    </style>
{% endblock %}

{% block content %}
    <h1>Data Management</h1>

    <!-- Import Results Section -->
    {% if import_results %}
    <div class="import-results" id="import-results-box">
        <a href="{{ url_for('management.clear_import_results') }}" class="dismiss-btn" title="Dismiss">&times;</a>
        <h2>Last Import Summary</h2>
        <p>{{ import_results.summary }}</p>
        <div class="summary-grid">
            <div class="stat">
                <div class="value value-success">{{ import_results.successes }}</div>
                <div class="label">Successes</div>
            </div>
            <div class="stat">
                <div class="value value-neutral">{{ import_results.duplicates }}</div>
                <div class="label">Duplicates</div>
            </div>
            <div class="stat">
                <div class="value value-error">{{ import_results.errors }}</div>
                <div class="label">Errors</div>
            </div>
        </div>
        <div class="actions">
            {% if import_results.report_filename %}
                <a href="{{ url_for('management.download_last_report') }}" class="button-link">Download Full Report</a>
            {% else %}
                <p><em>A full report is not available for this import.</em></p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <details id="manage-coverage-details">
        <summary>Manage Coverage</summary>
        <div class="form-grid-container">
            <div class="form-section">
                <h3>Create New Coverage Entry</h3>
                <form action="{{ url_for('management.add_coverage') }}" method="post">
                    <label for="tc_id">Test Case ID</label>
                    <input type="text" id="tc_id" name="tc_id" required>
                    <label for="tcid_title">TCID Title (Optional)</label>
                    <input type="text" id="tcid_title" name="tcid_title">
                    <label for="region">Region (Optional, comma-separated)</label>
                    <input type="text" id="region" name="region" placeholder="e.g., US, DE">
                    <label for="engine">Engine (Optional, comma-separated)</label>
                    <input type="text" id="engine" name="engine" placeholder="e.g., google, bing">
                    <label>Metric Type</label>
                    <div class="radio-group">
                        <label><input type="radio" name="metric_type" value="Glean" checked> Glean</label>
                        <label><input type="radio" name="metric_type" value="Legacy"> Legacy</label>
                    </div>
                    <label for="metrics">Associated Metrics (comma-separated)</label>
                    <textarea id="metrics" name="metrics" rows="3" required placeholder="e.g., glean.app.startup.time, glean.another.metric"></textarea>
                    <button type="submit">Add Entry</button>
                </form>
            </div>
            <div class="form-section">
                <h3>Bulk Import Coverage from CSV</h3>
                <form action="{{ url_for('management.bulk_import_coverage') }}" method="post" enctype="multipart/form-data">
                    <label for="coverage_file">Upload CSV File (TC_ID, Title, Metric, Type, Region, Engine)</label>
                    <input type="file" id="coverage_file" name="file" accept=".csv" required>
                    <button type="submit">Bulk Import Coverage</button>
                </form>
            </div>
        </div>
    </details>

    <details id="manage-exceptions-details">
        <summary>Manage Exceptions</summary>
        <div class="form-grid-container single-col">
            <div class="form-section">
                <h3>Add New Exception</h3>
                <p>TCIDs added here will be completely ignored by all data imports and will not appear in any metrics, reports, or planning pages.</p>
                <form action="{{ url_for('management.add_exception') }}" method="post">
                    <label for="exception_tc_id">Test Case ID</label>
                    <input type="text" id="exception_tc_id" name="tc_id" required>
                    <label for="exception_title">Title / Reason for Exception (Optional)</label>
                    <input type="text" id="exception_title" name="title">
                    <label for="exception_metrics">Associated Metrics (Optional, for reference)</label>
                    <input type="text" id="exception_metrics" name="metrics" placeholder="e.g., search.telemetry.something">
                    <button type="submit">Add Exception</button>
                </form>
            </div>
            <div class="form-section">
                <details>
                    <summary>View Current Exceptions ({{ exceptions|length }})</summary>
                    <table class="exception-table">
                        <thead>
                            <tr>
                                <th>TCID</th>
                                <th>Title / Reason</th>
                                <th>Metrics</th>
                                <th>Date Added</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exc in exceptions %}
                            <tr>
                                <td>{{ exc.tc_id }}</td>
                                <td>{{ exc.title or 'N/A' }}</td>
                                <td>{{ exc.metrics or 'N/A' }}</td>
                                <td>{{ exc.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <button class="delete-exception-btn" data-id="{{ exc.exception_id }}">Delete</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </details>
            </div>
        </div>
    </details>

    <details id="manage-glean-details">
        <summary>Manage Glean Metrics</summary>
        <div class="form-grid-container">
            <div class="form-section">
                <h3>Add New Glean Metric</h3>
                <form action="{{ url_for('management.add_glean_metric') }}" method="post">
                    <label for="glean_name">Glean Name</label>
                    <input type="text" id="glean_name" name="glean_name" required>
                    <label for="metric_type">Metric Type (Optional)</label>
                    <input type="text" id="metric_type" name="metric_type">
                    <label for="description">Description (Optional)</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                    <button type="submit">Add Glean Metric</button>
                </form>
            </div>
            <div class="form-section">
                <h3>Bulk Import Glean Metrics from CSV</h3>
                <form action="{{ url_for('management.bulk_import_glean') }}" method="post" enctype="multipart/form-data">
                    <label for="glean_file">Upload CSV File (Name, Type, Description, Expiration)</label>
                    <input type="file" id="glean_file" name="file" accept=".csv" required>
                    <button type="submit">Bulk Import Glean</button>
                </form>
            </div>
        </div>
    </details>

    <details id="manage-legacy-details">
        <summary>Manage Legacy Metrics</summary>
        <div class="form-grid-container">
            <div class="form-section">
                <h3>Add New Legacy Metric</h3>
                <form action="{{ url_for('management.add_legacy_metric') }}" method="post">
                    <label for="legacy_name">Legacy Name</label>
                    <input type="text" id="legacy_name" name="legacy_name" required>
                    <label for="metric_type_legacy">Metric Type (Optional)</label>
                    <input type="text" id="metric_type_legacy" name="metric_type">
                    <label for="description_legacy">Description (Optional)</label>
                    <textarea id="description_legacy" name="description" rows="3"></textarea>
                    <button type="submit">Add Legacy Metric</button>
                </form>
            </div>
            <div class="form-section">
                <h3>Bulk Import Legacy Metrics from CSV</h3>
                <form action="{{ url_for('management.bulk_import_legacy') }}" method="post" enctype="multipart/form-data">
                    <label for="legacy_file">Upload CSV File (Name, Type, Description, Expiration)</label>
                    <input type="file" id="legacy_file" name="file" accept=".csv" required>
                    <button type="submit">Bulk Import Legacy</button>
                </form>
            </div>
        </div>
    </details>

    <details id="manage-probe-extraction">
        <summary>Probe Extraction Tool</summary>
        <div class="form-grid-container single-col">
            <div class="form-section">
                <h3>Extract Probes from TestRail Export</h3>
                <p>Upload a CSV exported from TestRail. The tool will parse all columns to find probes, regions, and engines.</p>
                <form action="{{ url_for('management.extract_probes') }}" method="post" enctype="multipart/form-data">
                    <label for="testrail_file">Upload TestRail CSV Export</label>
                    <input type="file" id="testrail_file" name="file" accept=".csv" required>
                    <button type="submit">Extract and Download</button>
                </form>
            </div>
        </div>
    </details>

    <details id="manage-rotation-extraction">
        <summary>Extract from Rotation</summary>
        <div class="form-grid-container single-col">
            <div class="form-section">
                <h3>Extract Coverage from Rotation CSV</h3>
                <p>Upload a CSV with columns <strong>tcsid, title, rotation</strong>. The tool will auto-detect region/engine from the title and extract metrics from the rotation column, returning a new downloadable CSV with the found data.</p>
                <form action="{{ url_for('management.extract_from_rotation') }}" method="post" enctype="multipart/form-data">
                    <label for="rotation_file">Upload Rotation CSV</label>
                    <input type="file" id="rotation_file" name="file" accept=".csv" required>
                    <button type="submit">Extract and Download</button>
                </form>
            </div>
        </div>
    </details>

    <details id="manage-engines-details">
        <summary>Manage Supported Engines</summary>
        <div class="form-section" style="padding: 1rem 1rem 1.5rem;">
            <h3>Current Engines</h3>
            <ul id="engine-list" class="engine-list">
                {% for engine in supported_engines %}
                <li data-engine-name="{{ engine.name }}">
                    <span>{{ engine.name }}</span>
                    <button class="delete-engine-btn" data-name="{{ engine.name }}">Delete</button>
                </li>
                {% endfor %}
            </ul>
            <form id="add-engine-form" class="engine-form">
                <input type="text" id="new-engine-name" placeholder="Add new engine (e.g., yandex)" required>
                <button type="submit">Add Engine</button>
            </form>
            <div id="engine-message"></div>
        </div>
    </details>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // JavaScript for deleting engines and exceptions
    document.querySelectorAll('.delete-engine-btn').forEach(button => {
        button.addEventListener('click', function() {
            const engineName = this.dataset.name;
            if (confirm(`Are you sure you want to delete the engine "${engineName}"?`)) {
                fetch("{{ url_for('management.delete_engine') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `name=${encodeURIComponent(engineName)}`
                }).then(() => window.location.reload());
            }
        });
    });

    document.getElementById('add-engine-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const newEngineName = document.getElementById('new-engine-name').value;
        fetch("{{ url_for('management.add_engine') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `name=${encodeURIComponent(newEngineName)}`
        }).then(() => window.location.reload());
    });

    document.querySelectorAll('.delete-exception-btn').forEach(button => {
        button.addEventListener('click', function() {
            const exceptionId = this.dataset.id;
            const row = this.closest('tr');
            if (confirm('Are you sure you want to delete this exception?')) {
                fetch(`/manage/delete/exceptions/${exceptionId}`, {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        row.remove();
                    } else {
                        alert('Error: Could not delete exception. ' + (data.error || ''));
                    }
                });
            }
        });
    });
});
</script>
{% endblock %}