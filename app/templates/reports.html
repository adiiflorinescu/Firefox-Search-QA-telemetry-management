{% extends 'base.html' %}

{% block title %}Metric Reports{% endblock %}

{% block head_styles %}
    <style>
        .hidden { display: none; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background-color: #f9fafb; padding: 1.5rem; border-radius: 8px; text-align: center; border: 1px solid #eef; }
        .stat-card h3 { margin: 0 0 0.5rem 0; font-size: 1.1rem; color: #555; }
        .stat-card .value { font-size: 2.5rem; font-weight: bold; color: #1a2b4d; }
        .stat-card .percentage { font-size: 1rem; color: #4a5568; }

        .filters-container { display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center; }
        .filters-container input, .filters-container select, .filters-container button { padding: 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
        .filters-container input[type="search"] { flex-grow: 1; }
        #reset-filters-btn { background-color: #6c757d; color: white; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px; text-align: left; border: 1px solid #eef; vertical-align: middle; }
        th { background-color: #f2f4f8; font-size: 0.9rem; text-transform: uppercase; color: #555; }
        tr:hover { background-color: #f7f9fc; }
        .status-covered { color: #2f855a; font-weight: bold; }
        .status-uncovered { color: #c53030; font-weight: bold; }
        .metric-type-badge { display: inline-block; width: 20px; height: 20px; line-height: 20px; text-align: center; border-radius: 50%; color: white; font-weight: bold; font-size: 0.8rem; margin-right: 8px; }
        .glean-badge { background-color: #38a169; }
        .legacy-badge { background-color: #718096; }
    </style>
{% endblock %}

{% block content %}
    <h1>Metric Coverage Report</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Glean Metrics</h3>
            <div class="value">{{ total_glean_metrics }}</div>
        </div>
        <div class="stat-card">
            <h3>Glean Coverage</h3>
            <div class="value">{{ glean_covered_tcs }}</div>
            <div class="percentage">
                {% if total_glean_metrics > 0 %}
                    {{ "%.1f"|format((glean_covered_tcs / total_glean_metrics) * 100) }}%
                {% else %}
                    0.0%
                {% endif %}
            </div>
        </div>
        <div class="stat-card">
            <h3>Total Legacy Metrics</h3>
            <div class="value">{{ total_legacy_metrics }}</div>
        </div>
        <div class="stat-card">
            <h3>Legacy Coverage</h3>
            <div class="value">{{ legacy_covered_tcs }}</div>
            <div class="percentage">
                {% if total_legacy_metrics > 0 %}
                    {{ "%.1f"|format((legacy_covered_tcs / total_legacy_metrics) * 100) }}%
                {% else %}
                    0.0%
                {% endif %}
            </div>
        </div>
    </div>

    <div class="filters-container">
        <input type="search" id="search-field" placeholder="Search for metrics...">
        <input type="text" id="metric-type-filter" list="metric-types-list" placeholder="Filter by Metric Type...">
        <datalist id="metric-types-list">
            {% for type in metric_types %}
                <option value="{{ type.name }}">{{ type.name }} ({{ type.source[0] }})</option>
            {% endfor %}
        </datalist>
        <select id="coverage-filter">
            <option value="all" selected>All Coverage Status</option>
            <option value="covered">Covered</option>
            <option value="uncovered">Uncovered</option>
        </select>
        <button id="reset-filters-btn">Reset</button>
    </div>

    <table id="report-table">
        <thead>
            <tr>
                <th>Metric Name</th>
                <th>Coverage Status</th>
                <th>TCID Count</th>
            </tr>
        </thead>
        <tbody>
            {% for row in report_data %}
            <tr class="metric-row" data-metric-name="{{ row.name.lower() }}" data-specific-metric-type="{{ row.specific_type.lower() if row.specific_type else '' }}" data-coverage-status="{{ 'covered' if row.covered else 'uncovered' }}">
                <td>
                    <span class="metric-type-badge {{ row.type.lower() }}-badge">{{ row.type[0] }}</span>
                    {{ row.name }}
                </td>
                <td>
                    <span class="status-{{ 'covered' if row.covered else 'uncovered' }}">
                        {{ 'Covered' if row.covered else 'Not Covered' }}
                    </span>
                </td>
                <td>{{ row.tcid_count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchField = document.getElementById('search-field');
    const typeFilter = document.getElementById('metric-type-filter');
    const coverageFilter = document.getElementById('coverage-filter');
    const resetButton = document.getElementById('reset-filters-btn');
    const metricRows = document.querySelectorAll('.metric-row');

    function filterTable() {
        const searchTerm = searchField.value.trim().toLowerCase();
        const selectedType = typeFilter.value.trim().toLowerCase();
        const selectedCoverage = coverageFilter.value;

        metricRows.forEach(row => {
            const metricName = row.dataset.metricName;
            const specificMetricType = row.dataset.specificMetricType;
            const coverageStatus = row.dataset.coverageStatus;

            const matchesSearch = metricName.includes(searchTerm);
            const matchesType = (selectedType === '') || (specificMetricType.includes(selectedType));
            const matchesCoverage = (selectedCoverage === 'all') || (coverageStatus === selectedCoverage);

            const isVisible = matchesSearch && matchesType && matchesCoverage;
            row.classList.toggle('hidden', !isVisible);
        });
    }

    function resetFilters() {
        searchField.value = '';
        typeFilter.value = '';
        coverageFilter.value = 'all';
        filterTable();
    }

    searchField.addEventListener('input', filterTable);
    typeFilter.addEventListener('input', filterTable);
    coverageFilter.addEventListener('change', filterTable);
    resetButton.addEventListener('click', resetFilters);
});
</script>
{% endblock %}