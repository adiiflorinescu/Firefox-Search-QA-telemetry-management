<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coverage Planning - Dashboard</title>
    <style>
        /* Using the same consistent styling from other pages */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 2rem; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { color: #1a2b4d; }
        h1 { border-bottom: 2px solid #eef; padding-bottom: 10px; }
        nav { margin-bottom: 2rem; }
        nav a { text-decoration: none; color: #2c5282; font-weight: bold; margin-right: 1.5rem; font-size: 1.2rem; }
        nav a.active { border-bottom: 2px solid #2c5282; }
        .hidden { display: none; }

        .filters-container { display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center; }
        .filters-container input, .filters-container select {
            padding: 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px;
        }
        .filters-container input[type="search"] { flex-grow: 1; }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px; text-align: left; border: 1px solid #eef; vertical-align: middle; }
        th { background-color: #f2f4f8; font-size: 0.9rem; text-transform: uppercase; color: #555; }
        tr.metric-row:hover { background-color: #f7f9fc; cursor: pointer; }

        .metric-type-badge { display: inline-block; width: 20px; height: 20px; line-height: 20px; text-align: center; border-radius: 50%; color: white; font-weight: bold; font-size: 0.8rem; margin-right: 8px; }
        .glean-badge { background-color: #38a169; }
        .legacy-badge { background-color: #718096; }

        .col-metric-name { word-break: break-all; }
        .col-count { width: 100px; text-align: center; }
        .col-priority { width: 120px; }
        .col-priority select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }

        /* Sub-table styles */
        .details-container { padding: 1rem; background-color: #fdfdff; }
        .details-table { font-size: 0.9em; }
        .details-table th, .details-table td { padding: 8px; }
        .planned-entry { background-color: #fffbea !important; font-style: italic; color: #92400e; }
        .remove-btn { cursor: pointer; color: #c53030; font-weight: bold; }

        /* Styles for editable TCID and save button */
        .editable-tcid {
            width: 120px;
            padding: 4px;
            font-size: 1em;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background-color: #fefce8;
        }
        .save-tcid-btn {
            padding: 4px 8px;
            font-size: 0.9em;
            margin-left: 8px;
            cursor: pointer;
        }

        /* Styles for the add form */
        .add-plan-form input { padding: 6px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; }
        .add-plan-form button { padding: 6px 10px; font-size: 0.9em; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <nav>
        <a href="{{ url_for('index') }}" id="nav-data-management" class="{% if not show_management %}hidden{% endif %}">Data Management</a>
        <a href="{{ url_for('metrics') }}">View Metrics</a>
        <a href="{{ url_for('reports') }}">Metric Reports</a>
        <a href="{{ url_for('planning') }}" class="active">Coverage Planning</a>
    </nav>

    <h1>Coverage Planning</h1>

    <div class="filters-container">
        <input type="search" id="search-field" placeholder="Search for metrics...">
        <select id="priority-filter">
            <option value="all" selected>All Priorities</option>
            <option value="P1">P1</option>
            <option value="P2">P2</option>
            <option value="P3">P3</option>
            <option value="P4">P4</option>
            <option value="P5">P5</option>
            <option value="none">No Priority</option>
        </select>
        <select id="added-entries-filter">
            <option value="all" selected>All Metrics</option>
            <option value="added">With Planned Entries</option>
        </select>
    </div>

    <table id="planning-table">
        <thead>
            <tr>
                <th class="col-metric-name">Metric Name</th>
                <th class="col-count">TCID Count</th>
                <th class="col-count">Region Count</th>
                <th class="col-count">Engine Count</th>
                <th class="col-priority">TC Priority</th>
            </tr>
        </thead>
        <tbody>
            {% for row in planning_data %}
            <tr class="metric-row" data-metric-name="{{ row.metric_name }}" data-metric-type="{{ row.metric_type.lower() }}">
                <td class="col-metric-name">
                    <span class="metric-type-badge {{ row.metric_type.lower() }}-badge">{{ row.metric_type[0] }}</span>
                    {{ row.metric_name }}
                </td>
                <td class="col-count tcid-count-cell">{{ row.tcid_count }}</td>
                <td class="col-count">{{ row.region_count }}</td>
                <td class="col-count">{{ row.engine_count }}</td>
                <td class="col-priority">
                    {# DEFINITIVE FIX: Get priority directly from the row object. #}
                    <select class="priority-dropdown" data-metric-name="{{ row.metric_name }}" data-metric-type="{{ row.metric_type.lower() }}">
                        <option value="-" {% if not row.priority %}selected{% endif %}>-</option>
                        {% for i in range(1, 6) %}
                        <option value="P{{i}}" {% if row.priority == 'P' ~ i %}selected{% endif %}>P{{i}}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr class="sub-table-row hidden" data-metric-name="{{ row.metric_name }}" data-metric-type="{{ row.metric_type.lower() }}">
                <td colspan="5">
                    <div class="details-container">
                        <table class="details-table">
                            <thead>
                                <tr><th>Engine</th><th>Region</th><th>TC ID</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                                {% set existing = metric_to_existing_tcs.get((row.metric_name, row.metric_type.lower()), []) %}
                                {% set planned = metric_to_planned_tcs.get((row.metric_name, row.metric_type.lower()), []) %}

                                {% for tc in existing | sort_details %}
                                <tr>
                                    <td>{{ tc.engine or 'NoEngine' }}</td>
                                    <td>{{ tc.region or 'NoRegion' }}</td>
                                    <td><a href="{{ tc_base_url }}{{ tc.tc_id | strip_tcid_prefix }}" target="_blank">{{ tc.tc_id }}</a></td>
                                    <td></td>
                                </tr>
                                {% endfor %}

                                {% for tc in planned %}
                                <tr class="planned-entry" data-planning-id="{{ tc.planning_id }}">
                                    <td>{{ tc.engine or 'NoEngine' }}</td>
                                    <td>{{ tc.region or 'NoRegion' }}</td>
                                    <td>
                                        <input type="text" class="editable-tcid" value="" placeholder="Add TC ID to promote...">
                                        <button class="save-tcid-btn">Save</button>
                                    </td>
                                    <td><span class="remove-btn">âœ–</span></td>
                                </tr>
                                {% endfor %}
                                {# Add new plan form #}
                                <tr class="add-plan-form">
                                    <td><input type="text" class="new-plan-engine" placeholder="Engine..."></td>
                                    <td><input type="text" class="new-plan-region" placeholder="Region..."></td>
                                    <td></td>
                                    <td><button class="add-plan-btn">Add Plan</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('planning-table');

    // Toggle sub-table visibility
    table.addEventListener('click', function(e) {
        if (e.target.tagName === 'SELECT' || e.target.tagName === 'OPTION' || e.target.closest('.sub-table-row')) {
            return; // Don't toggle if clicking on interactive elements
        }
        if (e.target.closest('.metric-row')) {
            const row = e.target.closest('.metric-row');
            const metricName = row.dataset.metricName;
            const metricType = row.dataset.metricType;

            const subTableRow = table.querySelector(`.sub-table-row[data-metric-name="${metricName}"][data-metric-type="${metricType}"]`);
            if (subTableRow) {
                subTableRow.classList.toggle('hidden');
            }
        }
    });

    // Handle AJAX updates for priority dropdown
    table.addEventListener('change', function(e) {
        if (e.target.classList.contains('priority-dropdown')) {
            updatePlanning({
                action: 'set_priority',
                metric_name: e.target.dataset.metricName,
                metric_type: e.target.dataset.metricType,
                priority: e.target.value
            });
        }
    });

    // Add keydown listener for 'Enter' key on the add form
    table.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.closest('.add-plan-form')) {
            e.preventDefault(); // Prevent default form submission
            const formRow = e.target.closest('.add-plan-form');
            formRow.querySelector('.add-plan-btn').click(); // Trigger the button click
        }
    });

    // Handle AJAX updates within the sub-table (add, remove, save)
    table.addEventListener('click', function(e) {
        const subTableRow = e.target.closest('.sub-table-row');
        if (!subTableRow) return;

        const metricName = subTableRow.dataset.metricName;
        const metricType = subTableRow.dataset.metricType;

        // Add new planned entry
        if (e.target.classList.contains('add-plan-btn')) {
            const formRow = e.target.closest('.add-plan-form');
            const regionInput = formRow.querySelector('.new-plan-region');
            const engineInput = formRow.querySelector('.new-plan-engine');

            if (!regionInput.value.trim() && !engineInput.value.trim()) {
                alert('At least a Region or Engine is required to add a plan.');
                return;
            }

            const payload = {
                action: 'add_plan',
                metric_name: metricName,
                metric_type: metricType,
                region: regionInput.value.trim(),
                engine: engineInput.value.trim()
            };

            updatePlanning(payload).then(data => {
                if (data.success) {
                    // Reload to show the new entry correctly sorted.
                    window.location.reload();
                }
            });
        }

        // Remove planned entry
        if (e.target.classList.contains('remove-btn')) {
            if (!confirm('Are you sure you want to remove this planned entry?')) return;
            const plannedRow = e.target.closest('.planned-entry');
            updatePlanning({
                action: 'remove_plan',
                metric_name: metricName,
                metric_type: metricType,
                planning_id: plannedRow.dataset.planningId
            }).then(data => {
                if (data.success) {
                    // No need to manually update count, just remove the row
                    plannedRow.remove();
                }
            });
        }

        // Save/Promote planned entry
        if (e.target.classList.contains('save-tcid-btn')) {
            const plannedRow = e.target.closest('.planned-entry');
            const tcidInput = plannedRow.querySelector('.editable-tcid');
            const newTcId = tcidInput.value.trim();

            if (!newTcId) {
                alert('Please provide a valid TC ID to save this entry as coverage.');
                return;
            }

            if (!confirm(`This will add '${newTcId}' to the main coverage and remove this planned entry. Continue?`)) return;

            updatePlanning({
                action: 'promote_to_coverage',
                metric_name: metricName,
                metric_type: metricType,
                planning_id: plannedRow.dataset.planningId,
                new_tc_id: newTcId
            }).then(data => {
                if (data.success) window.location.reload();
            });
        }
    });

    async function updatePlanning(payload) {
        try {
            const response = await fetch("{{ url_for('update_planning_entry') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) {
                alert('Error: ' + (data.error || 'Server error'));
                return { success: false };
            }
            return { ...data, success: true };
        } catch (error) {
            console.error('Update failed:', error);
            alert('An unexpected error occurred.');
            return { success: false };
        }
    }

    // Filtering logic
    const searchField = document.getElementById('search-field');
    const priorityFilter = document.getElementById('priority-filter');
    const addedEntriesFilter = document.getElementById('added-entries-filter');
    const metricRows = document.querySelectorAll('.metric-row');

    function filterTable() {
        const searchTerm = searchField.value.toLowerCase();
        const selectedPriority = priorityFilter.value;
        const selectedAdded = addedEntriesFilter.value;

        metricRows.forEach(row => {
            const metricName = row.dataset.metricName.toLowerCase();
            const metricType = row.dataset.metricType;
            const priority = row.querySelector('.priority-dropdown').value;
            const subTableRow = table.querySelector(`.sub-table-row[data-metric-name="${row.dataset.metricName}"][data-metric-type="${metricType}"]`);
            const hasAddedEntries = subTableRow.querySelector('.planned-entry') !== null;

            const matchesSearch = metricName.includes(searchTerm);
            const matchesPriority = (selectedPriority === 'all') || (priority === selectedPriority) || (selectedPriority === 'none' && priority === '-');
            const matchesAdded = (selectedAdded === 'all') || (selectedAdded === 'added' && hasAddedEntries);

            const isVisible = matchesSearch && matchesPriority && matchesAdded;
            row.classList.toggle('hidden', !isVisible);
            if (!isVisible) {
                subTableRow.classList.add('hidden');
            }
        });
    }

    searchField.addEventListener('input', filterTable);
    priorityFilter.addEventListener('change', filterTable);
    addedEntriesFilter.addEventListener('change', filterTable);
});
</script>

</body>
</html>