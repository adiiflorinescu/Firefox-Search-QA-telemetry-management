<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coverage Planning - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Styles from your provided file */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 2rem; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { color: #1a2b4d; }
        h1 { border-bottom: 2px solid #eef; padding-bottom: 10px; }
        nav { margin-bottom: 2rem; }
        nav a { text-decoration: none; color: #2c5282; font-weight: bold; margin-right: 1.5rem; font-size: 1.2rem; }
        nav a.active { border-bottom: 2px solid #2c5282; }
        .hidden { display: none; }
        .filters-container { display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center; }
        .filters-container input, .filters-container select, .filters-container button { padding: 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
        .filters-container input[type="search"] { flex-grow: 1; }
        #reset-filters-btn { background-color: #6c757d; color: white; cursor: pointer; }
        #reset-filters-btn:hover { background-color: #5a6268; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px; text-align: left; border: 1px solid #eef; vertical-align: middle; }
        th { background-color: #f2f4f8; font-size: 0.9rem; text-transform: uppercase; color: #555; }
        tr.metric-row:hover { background-color: #f7f9fc; cursor: pointer; }
        .metric-type-badge { display: inline-block; width: 20px; height: 20px; line-height: 20px; text-align: center; border-radius: 50%; color: white; font-weight: bold; font-size: 0.8rem; margin-right: 8px; }
        .glean-badge { background-color: #38a169; }
        .legacy-badge { background-color: #718096; }
        .col-metric-name { word-break: break-all; }
        .col-count { width: 100px; text-align: center; }
        .col-priority { width: 150px; }
        .col-priority > div { display: flex; align-items: center; gap: 10px; }
        .col-priority select { flex-grow: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
        .notes-icon { font-size: 1.2rem; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .notes-icon:hover { opacity: 1; }
        .notes-icon.active { color: #2c5282; opacity: 1; }
        .details-container { padding: 1rem; background-color: #fdfdff; }
        .details-table { font-size: 0.9em; }
        .details-table th, .details-table td { padding: 8px; }
        .planned-entry { background-color: #fffbea !important; font-style: italic; color: #92400e; }
        .remove-btn { cursor: pointer; color: #c53030; font-weight: bold; }
        .notes-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #ccc; }
        .notes-section h4 { margin: 0 0 0.5rem 0; font-size: 1em; color: #333; }
        .notes-section textarea { width: 100%; min-height: 80px; padding: 8px; font-size: 1em; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; resize: vertical; }
        .editable-tcid { width: 120px; padding: 4px; font-size: 1em; border: 1px solid #d1d5db; border-radius: 4px; background-color: #fefce8; }
        .save-tcid-btn { padding: 4px 8px; font-size: 0.9em; margin-left: 8px; cursor: pointer; }
        .add-plan-form input { padding: 6px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; }
        .add-plan-form button { padding: 6px 10px; font-size: 0.9em; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <nav>
        {# DEFINITIVE FIX: Check if g.user exists before accessing its properties #}
        {% if g.user and g.user.role == 'admin' %}
            <a href="{{ url_for('management.index') }}">Data Management</a>
            <a href="{{ url_for('main.activity_log') }}">Activity Log</a>
        {% endif %}
        <a href="{{ url_for('main.metrics') }}">View Metrics</a>
        <a href="{{ url_for('main.reports') }}">Metric Reports</a>
        <a href="{{ url_for('planning.view_planning') }}" class="active">Coverage Planning</a>
        {% if g.user and g.user.role == 'admin' %}
            <a href="{{ url_for('user_management.index') }}">User Management</a>
        {% endif %}

        {% if g.user %}
            <a href="{{ url_for('auth.logout') }}" style="float: right;">Logout ({{ g.user.username }})</a>
        {% else %}
            <a href="{{ url_for('auth.login') }}" style="float: right;">Login</a>
        {% endif %}
    </nav>

    <h1>Coverage Planning</h1>

    <div class="filters-container">
        <!-- Filters remain the same -->
        <input type="search" id="search-field" placeholder="Search for metrics...">
        <input type="text" id="metric-type-filter" list="metric-types-list" placeholder="Filter by Metric Type...">
        <datalist id="metric-types-list">
            {% for type in metric_types %}
                <option value="{{ type.name }}">{{ type.name }} ({{ type.source[0] }})</option>
            {% endfor %}
        </datalist>
        <select id="priority-filter">
            <option value="all" selected>All Priorities</option>
            <option value="P1">P1</option>
            <option value="P2">P2</option>
            <option value="P3">P3</option>
            <option value="P4">P4</option>
            <option value="P5">P5</option>
            <option value="SkipCoverage">Skip Coverage</option>
            <option value="none">No Priority</option>
        </select>
        <select id="added-entries-filter">
            <option value="all" selected>All Metrics</option>
            <option value="added">With Planned Entries</option>
        </select>
        <button id="reset-filters-btn">Reset</button>
    </div>

    <table id="planning-table">
        <thead>
            <tr>
                <th class="col-metric-name">Metric Name</th>
                <th class="col-count">TCID Count</th>
                <th class="col-count">Region Count</th>
                <th class="col-count">Engine Count</th>
                <th class="col-priority">TC Priority</th>
            </tr>
        </thead>
        <tbody>
            {% for row in planning_data %}
            <tr class="metric-row" data-metric-name="{{ row.metric_name }}" data-metric-type="{{ row.metric_type.lower() }}" data-specific-metric-type="{{ row.specific_metric_type.lower() if row.specific_metric_type else '' }}">
                <td class="col-metric-name">
                    <span class="metric-type-badge {{ row.metric_type.lower() }}-badge">{{ row.metric_type[0] }}</span>
                    {{ row.metric_name }}
                </td>
                <td class="col-count tcid-count-cell">{{ row.tcid_count }}</td>
                <td class="col-count">{{ row.region_count }}</td>
                <td class="col-count">{{ row.engine_count }}</td>
                <td class="col-priority">
                    <div>
                        <!-- ROLE-BASED CONTROL: Disable for readonly -->
                        <select class="priority-dropdown" data-metric-name="{{ row.metric_name }}" data-metric-type="{{ row.metric_type.lower() }}" {% if not g.user or g.user.role == 'readonly' %}disabled{% endif %}>
                            <option value="-" {% if not row.priority %}selected{% endif %}>-</option>
                            {% for i in range(1, 6) %}
                            <option value="P{{i}}" {% if row.priority == 'P' ~ i %}selected{% endif %}>P{{i}}</option>
                            {% endfor %}
                            <option value="SkipCoverage" {% if row.priority == 'SkipCoverage' %}selected{% endif %}>Skip Coverage</option>
                        </select>
                        <span class="notes-icon {% if row.notes %}active{% endif %}" title="Edit Notes">üìù</span>
                    </div>
                </td>
            </tr>
            <tr class="sub-table-row hidden" data-metric-name="{{ row.metric_name }}" data-metric-type="{{ row.metric_type.lower() }}">
                <td colspan="5">
                    <div class="details-container">
                        <table class="details-table">
                            <thead>
                                <tr><th>Engine</th><th>Region</th><th>TC ID</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                                {% set existing = metric_to_existing_tcs.get((row.metric_name, row.metric_type.lower()), []) %}
                                {% set planned = metric_to_planned_tcs.get((row.metric_name, row.metric_type.lower()), []) %}

                                {% for tc in existing | sort_details %}
                                <tr>
                                    <td>{{ tc.engine or 'NoEngine' }}</td>
                                    <td>{{ tc.region or 'NoRegion' }}</td>
                                    <td><a href="{{ tc_base_url }}{{ tc.tc_id | strip_tcid_prefix }}" target="_blank">{{ tc.tc_id }}</a></td>
                                    <td></td>
                                </tr>
                                {% endfor %}

                                {% for tc in planned %}
                                <tr class="planned-entry" data-planning-id="{{ tc.planning_id }}">
                                    <td>{{ tc.engine or 'NoEngine' }}</td>
                                    <td>{{ tc.region or 'NoRegion' }}</td>
                                    <td>
                                        <!-- ROLE-BASED CONTROL: Hide for readonly -->
                                        {% if g.user and g.user.role != 'readonly' %}
                                            <input type="text" class="editable-tcid" value="" placeholder="Add TC ID to promote...">
                                            <button class="save-tcid-btn">Save</button>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <!-- ROLE-BASED CONTROL: Hide for readonly -->
                                        {% if g.user and g.user.role != 'readonly' %}
                                            <span class="remove-btn">‚úñ</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}

                                <!-- ROLE-BASED CONTROL: Hide for readonly -->
                                {% if g.user and g.user.role != 'readonly' %}
                                <tr class="add-plan-form">
                                    <td><input type="text" class="new-plan-engine" placeholder="Engine..."></td>
                                    <td><input type="text" class="new-plan-region" placeholder="Region..."></td>
                                    <td></td>
                                    <td><button class="add-plan-btn">Add Plan</button></td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>

                        <div class="notes-section {% if not row.notes %}hidden{% endif %}">
                            <h4>Notes</h4>
                            <!-- ROLE-BASED CONTROL: Make readonly -->
                            <textarea class="notes-textarea" placeholder="Add planning notes here..." {% if not g.user or g.user.role == 'readonly' %}readonly{% endif %}>{{ row.notes or '' }}</textarea>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Your existing JavaScript logic remains the same.
// The server-side rendering handles the permissions, so the JS
// will only interact with the elements available to the user.
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('planning-table');
    const tcBaseUrl = "{{ tc_base_url }}";

    // Event delegation for all clicks on the table
    table.addEventListener('click', function(e) {
        const metricRow = e.target.closest('.metric-row');
        const subTableRow = e.target.closest('.sub-table-row');

        // Toggle sub-table visibility, excluding certain elements
        if (metricRow && !e.target.classList.contains('notes-icon') && e.target.tagName !== 'SELECT' && e.target.tagName !== 'OPTION') {
            const subRow = metricRow.nextElementSibling;
            if (subRow && subRow.classList.contains('sub-table-row')) {
                subRow.classList.toggle('hidden');
            }
        }

        // Handle notes icon click
        if (e.target.classList.contains('notes-icon')) {
            const parentRow = e.target.closest('.metric-row');
            const subRow = parentRow.nextElementSibling;
            if (subRow) {
                const notesSection = subRow.querySelector('.notes-section');
                notesSection.classList.toggle('hidden');
                if (!notesSection.classList.contains('hidden')) {
                    subRow.classList.remove('hidden');
                    notesSection.querySelector('textarea').focus();
                }
            }
        }

        // Handle "Add Plan" button click
        if (e.target.classList.contains('add-plan-btn')) {
            const formRow = e.target.closest('.add-plan-form');
            const subRow = formRow.closest('.sub-table-row');
            const metricName = subRow.dataset.metricName;
            const metricType = subRow.dataset.metricType;
            const region = formRow.querySelector('.new-plan-region').value.trim();
            const engine = formRow.querySelector('.new-plan-engine').value.trim();

            updatePlanning({
                action: 'add_plan',
                metric_name: metricName,
                metric_type: metricType,
                region: region,
                engine: engine
            }).then(data => {
                if (data.success) {
                    // Dynamically add the new row to the UI
                    const newRow = document.createElement('tr');
                    newRow.classList.add('planned-entry');
                    newRow.dataset.planningId = data.new_id;
                    newRow.innerHTML = `
                        <td>${engine || 'NoEngine'}</td>
                        <td>${region || 'NoRegion'}</td>
                        <td>
                            <input type="text" class="editable-tcid" value="" placeholder="Add TC ID to promote...">
                            <button class="save-tcid-btn">Save</button>
                        </td>
                        <td><span class="remove-btn">‚úñ</span></td>
                    `;
                    formRow.before(newRow);
                    // Clear input fields
                    formRow.querySelector('.new-plan-region').value = '';
                    formRow.querySelector('.new-plan-engine').value = '';
                }
            });
        }

        // Handle "Remove Plan" button click
        if (e.target.classList.contains('remove-btn')) {
            const plannedRow = e.target.closest('.planned-entry');
            const planningId = plannedRow.dataset.planningId;
            if (confirm('Are you sure you want to remove this planned entry?')) {
                updatePlanning({ action: 'remove_plan', planning_id: planningId }).then(data => {
                    if (data.success) {
                        plannedRow.remove();
                    }
                });
            }
        }

        // Handle "Save TCID" (Promote) button click
        if (e.target.classList.contains('save-tcid-btn')) {
            const plannedRow = e.target.closest('.planned-entry');
            const planningId = plannedRow.dataset.planningId;
            const newTcid = plannedRow.querySelector('.editable-tcid').value.trim();
            if (!newTcid) {
                alert('Please enter a TC ID to promote this entry.');
                return;
            }

            const region = plannedRow.cells[1].textContent;
            const engine = plannedRow.cells[0].textContent;

            updatePlanning({ action: 'promote_to_coverage', planning_id: planningId, new_tc_id: newTcid }).then(data => {
                if (data.success) {
                    const subTableRow = plannedRow.closest('.sub-table-row');
                    const mainRow = subTableRow.previousElementSibling;
                    const countCell = mainRow.querySelector('.tcid-count-cell');
                    countCell.textContent = parseInt(countCell.textContent) + 1;

                    const newExistingRow = document.createElement('tr');
                    const tcidPrefixStripped = newTcid.match(/\d.*/) ? newTcid.match(/\d.*/)[0] : newTcid;
                    newExistingRow.innerHTML = `
                        <td>${engine}</td>
                        <td>${region}</td>
                        <td><a href="${tcBaseUrl}${tcidPrefixStripped}" target="_blank">${newTcid}</a></td>
                        <td></td>
                    `;

                    const tableBody = plannedRow.closest('tbody');
                    tableBody.prepend(newExistingRow);
                    plannedRow.remove();
                }
            });
        }
    });

    async function updatePlanning(payload) {
        try {
            const response = await fetch("{{ url_for('planning.update_planning_entry') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!data.success) {
                alert('An error occurred: ' + (data.error || 'Unknown error'));
            }
            return data;
        } catch (error) {
            console.error('Update failed:', error);
            alert('A network or server error occurred.');
            return { success: false };
        }
    }

    table.addEventListener('change', function(e) {
        if (e.target.classList.contains('priority-dropdown')) {
            const metricName = e.target.dataset.metricName;
            const metricType = e.target.dataset.metricType;
            const priority = e.target.value;
            updatePlanning({ action: 'set_priority', metric_name: metricName, metric_type: metricType, priority: priority });
        }
        if (e.target.classList.contains('notes-textarea')) {
            const subRow = e.target.closest('.sub-table-row');
            const metricName = subRow.dataset.metricName;
            const metricType = subRow.dataset.metricType;
            const notes = e.target.value;
            updatePlanning({ action: 'save_notes', metric_name: metricName, metric_type: metricType, notes: notes });
            const notesIcon = subRow.previousElementSibling.querySelector('.notes-icon');
            notesIcon.classList.toggle('active', notes.trim() !== '');
        }
    });

    // Filtering logic
    const searchField = document.getElementById('search-field');
    const priorityFilter = document.getElementById('priority-filter');
    const addedEntriesFilter = document.getElementById('added-entries-filter');
    const typeFilter = document.getElementById('metric-type-filter');
    const resetButton = document.getElementById('reset-filters-btn');
    const metricRows = document.querySelectorAll('.metric-row');

    function filterTable() {
        const searchTerm = searchField.value.trim().toLowerCase();
        const selectedPriority = priorityFilter.value;
        const selectedAdded = addedEntriesFilter.value;
        const selectedType = typeFilter.value.trim().toLowerCase();

        metricRows.forEach(row => {
            const metricName = row.dataset.metricName.toLowerCase();
            const specificMetricType = row.dataset.specificMetricType;
            const priority = row.querySelector('.priority-dropdown').value;
            const subTableRow = row.nextElementSibling;
            const hasAddedEntries = subTableRow.querySelector('.planned-entry') !== null;

            const matchesSearch = metricName.includes(searchTerm);
            const matchesPriority = (selectedPriority === 'all') || (priority === selectedPriority) || (selectedPriority === 'none' && priority === '-');
            const matchesAdded = (selectedAdded === 'all') || (selectedAdded === 'added' && hasAddedEntries);
            const matchesType = (selectedType === '') || (specificMetricType.includes(selectedType));

            const isVisible = matchesSearch && matchesPriority && matchesAdded && matchesType;
            row.classList.toggle('hidden', !isVisible);
            if (!isVisible) {
                subTableRow.classList.add('hidden');
            }
        });
    }

    function resetFilters() {
        searchField.value = '';
        typeFilter.value = '';
        priorityFilter.value = 'all';
        addedEntriesFilter.value = 'all';
        filterTable();
    }

    searchField.addEventListener('input', filterTable);
    priorityFilter.addEventListener('change', filterTable);
    addedEntriesFilter.addEventListener('change', filterTable);
    typeFilter.addEventListener('input', filterTable);
    resetButton.addEventListener('click', resetFilters);
});
</script>

</body>
</html>